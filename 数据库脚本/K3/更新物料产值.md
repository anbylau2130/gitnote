
SELECT 
mtr.F_HXN_Price AS 现产值,
taxL.FNAME 现税率,
mtr.FNUMBER AS 物料编码,
mtrStock.FREFCOST AS 参考成本,
dbo.CMK_FN_GetUnitConvertRate(mtr.FMATERIALID,mtrStock.FSTOREUNITID,mtrBase.FBASEUNITID) AS 转换率,
((100+tax.FTAXRATE)/100.0000) AS [税率],

mtrStock.FREFCOST *dbo.CMK_FN_GetUnitConvertRate(mtr.FMATERIALID,mtrStock.FSTOREUNITID,mtrBase.FBASEUNITID)/( (100+tax.FTAXRATE)/100.0000 ) AS  计算后产值

FROM T_BD_MATERIAL mtr 
LEFT JOIN t_BD_MaterialBase mtrBase ON mtrBase.FMATERIALID = mtr.FMATERIALID
LEFT JOIN t_BD_MaterialStock mtrStock ON mtrStock.FMATERIALID = mtr.FMATERIALID
LEFT JOIN dbo.T_BD_TAXRATE tax ON mtrBase.FTAXRATEID=tax.FID
LEFT JOIN dbo.T_BD_TAXRATE_L taxL ON mtrBase.FTAXRATEID=taxL.FID
WHERE mtr.FUSEORGID=1 AND mtr.F_HXN_PRICE<>0
ORDER BY 物料编码  





UPDATE mtr SET 
mtr.F_HXN_Price=mtrStock.FREFCOST *dbo.CMK_FN_GetUnitConvertRate(mtr.FMATERIALID,mtrStock.FSTOREUNITID,mtrBase.FBASEUNITID)/( (100+tax.FTAXRATE)/100.0000 )
FROM T_BD_MATERIAL mtr 
LEFT JOIN t_BD_MaterialBase mtrBase ON mtrBase.FMATERIALID = mtr.FMATERIALID
LEFT JOIN t_BD_MaterialStock mtrStock ON mtrStock.FMATERIALID = mtr.FMATERIALID
LEFT JOIN dbo.T_BD_TAXRATE tax ON mtrBase.FTAXRATEID=tax.FID
LEFT JOIN dbo.T_BD_TAXRATE_L taxL ON mtrBase.FTAXRATEID=taxL.FID
WHERE mtr.FUSEORGID<>1 AND mtr.F_HXN_PRICE<>0
 
  
