--海信调拨接口
--select a.原始单号,sum(a.数量) as 数量,count(a.原始单号) 行数 from (
--
--select A.SourceBillNo 原始单号,P.SerialNo 序号,P.PluCode 物料编码,(select K.Unitcode from tCobPluPacket K where K.Packutid = P.Packutid) 单位,P.OrdCount 数量,P.Remark 备注
--from tStkMovPlanPlu P,tStkMovPlan A
--where A.BILLNO = P.BILLNO AND
-- p.billno in
-- (
-- select billno
-- from tStkMovPlan A
-- where A.OPRORGCODE in (select ORGID from TCOBSHOP where ISUPLOADSALE = '1')
-- and BILLNO not in (select BILLNO from tSfHxnPurMovOrd_Io)
-- and billstatus=2
-- )
-- and A.CRTDATE>=to_date('2018-09-28','YYYY-MM-DD')
--) a
--group by a.原始单号;
 
if object_id('tempdb..#temp') is not null Begin
 drop table #temp
End
CREATE TABLE #temp (
原始单号 VARCHAR(max), 数量 INT , 行数 INT
)
 
SELECT a.原始单号,b.FBILLNO,a.数量-b.QTY FROM #temp a
LEFT JOIN 
(
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FQTY) QTY FROM T_STK_STKTRANSFERIN a
 LEFT JOIN dbo.T_STK_STKTRANSFERINENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
UNION ALL
SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FREALQTY) QTY FROM t_STK_InStock a
 LEFT JOIN dbo.T_STK_INSTOCKENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
UNION ALL
SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FRMREALQTY) QTY FROM t_PUR_MRB a 
 LEFT JOIN dbo.T_PUR_MRBENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
) b ON a.原始单号=b.FORIGINNUMBER 
WHERE a.数量-b.QTY>1 OR a.数量-b.QTY<-1
 
SELECT a.原始单号,b.FBILLNO,a.数量,b.QTY FROM #temp a
LEFT JOIN 
(
 --直接调拨单
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FQTY) QTY FROM T_STK_STKTRANSFERIN a
 LEFT JOIN dbo.T_STK_STKTRANSFERINENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
UNION ALL
 --采购入库
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FREALQTY) QTY FROM t_STK_InStock a
 LEFT JOIN dbo.T_STK_INSTOCKENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
UNION ALL
 --采购退货
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FRMREALQTY) QTY FROM t_PUR_MRB a 
 LEFT JOIN dbo.T_PUR_MRBENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
) b ON a.原始单号=b.FORIGINNUMBER 
WHERE b.FBILLNO IS NULL
 
 
SELECT a.原始单号,b.FBILLNO,a.数量,b.QTY FROM #temp a
LEFT JOIN 
(
 --直接调拨单
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FQTY) QTY FROM T_STK_STKTRANSFERIN a
 LEFT JOIN dbo.T_STK_STKTRANSFERINENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
UNION ALL
 --采购入库
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FREALQTY) QTY FROM t_STK_InStock a
 LEFT JOIN dbo.T_STK_INSTOCKENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
UNION ALL
 --采购退货
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FRMREALQTY) QTY FROM t_PUR_MRB a 
 LEFT JOIN dbo.T_PUR_MRBENTRY b ON a.FID=b.FID
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
) b ON a.原始单号=b.FORIGINNUMBER 
WHERE b.FBILLNO IS NULL
 
 
 
SELECT tl.FORIGINNUMBER AS 原始单号,tl.日期,
tl.FBILLNO AS 退料单号,rk.FBILLNO AS 入库单号,ck.FBILLNO AS 出库单号,th.FBILLNO AS 退货单号,
tl.QTY 退料数量,rk.QTY 入库数量,ck.QTY 出库数量,th.QTY 退货数量,
tl.AMOUNT 退料金额,rk.AMOUNT 入库金额,ck.AMOUNT 出库金额,th.AMOUNT 退货金额
FROM (
--采购退货
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FRMREALQTY) QTY,SUM(c.FALLAMOUNT) AMOUNT,a.FDATE AS 日期 FROM t_PUR_MRB a 
 LEFT JOIN dbo.T_PUR_MRBENTRY b ON a.FID=b.FID
 LEFT JOIN T_PUR_MRBENTRY_F c ON c.FENTRYID = b.FENTRYID
 LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
 WHERE a.FORIGINNUMBER IS NOT NULL AND u.FNAME='Administrator'
 GROUP BY a.FBILLNO,a.FORIGINNUMBER,a.FDATE 
) tl
LEFT JOIN (
 --采购入库
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FREALQTY) QTY,c.FBILLALLAMOUNT AMOUNT FROM t_STK_InStock a
 LEFT JOIN dbo.T_STK_INSTOCKENTRY b ON a.FID=b.FID
 LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
 LEFT JOIN t_STK_InStockFin c ON c.FID=a.FID 
 WHERE a.FORIGINNUMBER IS NOT NULL AND u.FNAME='Administrator' 
 GROUP BY a.FBILLNO,a.FORIGINNUMBER,c.FBILLALLAMOUNT
) rk ON tl.FORIGINNUMBER=rk.FORIGINNUMBER
LEFT JOIN ( 
 --销售出库
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FREALQTY) QTY,SUM(c.FALLAMOUNT) AMOUNT FROM dbo.T_SAL_OUTSTOCK a
 LEFT JOIN dbo.T_SAL_OUTSTOCKENTRY b ON a.FID=b.FID
 LEFT JOIN dbo.T_SAL_OUTSTOCKENTRY_F c ON c.FENTRYID = b.FENTRYID
 LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
 WHERE a.FORIGINNUMBER IS NOT NULL AND u.FNAME='Administrator'
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
) ck ON ck.FORIGINNUMBER=rk.FORIGINNUMBER
LEFT JOIN (
 --销售退货
 SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FREALQTY) QTY,SUM(c.FALLAMOUNT) AMOUNT FROM dbo.T_SAL_RETURNSTOCK a
 LEFT JOIN dbo.T_SAL_RETURNSTOCKENTRY b ON b.FID = a.FID
 LEFT JOIN dbo.T_SAL_RETURNSTOCKENTRY_F c ON c.FENTRYID = b.FENTRYID
 LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
 WHERE a.FORIGINNUMBER IS NOT NULL AND u.FNAME='Administrator'
 GROUP BY a.FBILLNO,a.FORIGINNUMBER
) th ON th.FORIGINNUMBER=ck.FORIGINNUMBER﻿​