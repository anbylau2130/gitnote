--海信退货确认
--select a.BILLNO,a.AUDITDATE,sum(a.AUDITCOUNT) as qty
-- from tShpDisRtnApply a
--where a.AUDITDATE is not null
--and CRTDATE>=to_date('2018-09-28','YYYY-MM-DD')
--group by a.BILLNO,a.AUDITDATE;
if object_id('tempdb..#temp') is not null Begin
 drop table #temp
End
CREATE TABLE #temp (
billNO VARCHAR(max),
AUDITDATE DATETIME,
QTY INT 
)
--金蝶直接调拨单 退货数据查询
SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FQTY) qty FROM dbo.T_STK_STKTRANSFERIN a
LEFT JOIN dbo.T_STK_STKTRANSFERINENTRY b ON a.FID=b.FID
LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
WHERE a.FDOCUMENTSTATUS='C' AND a.FSERVICETYPE=1 AND a.FDATASRC=1
GROUP BY a.FBILLNO ,a.FORIGINNUMBER
 
SELECT * FROM #temp a 
LEFT JOIN (
SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FQTY) qty FROM dbo.T_STK_STKTRANSFERIN a
LEFT JOIN dbo.T_STK_STKTRANSFERINENTRY b ON a.FID=b.FID
LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
WHERE a.FDOCUMENTSTATUS='C' AND a.FSERVICETYPE=1 AND a.FDATASRC=1
GROUP BY a.FBILLNO ,a.FORIGINNUMBER
) b ON a.BILLNO=b.FORIGINNUMBER
WHERE b.FBILLNO IS NULL
 
--单子在金蝶审核未到海信
SELECT * FROM #temp a 
LEFT JOIN (
SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FQTY) qty FROM dbo.T_STK_STKTRANSFERIN a
LEFT JOIN dbo.T_STK_STKTRANSFERINENTRY b ON a.FID=b.FID
LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
WHERE a.FDOCUMENTSTATUS='C' AND a.FSERVICETYPE=1 AND a.FDATASRC=1
GROUP BY a.FBILLNO ,a.FORIGINNUMBER
) b ON a.BILLNO=b.FORIGINNUMBER
WHERE a.BILLNO IS NULL OR b.FBILLNO IS NULL﻿​