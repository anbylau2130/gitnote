--select a.FSOURCEBILLNO as 原始单号,a.FDATE as 日期,sum(b.FQTY) as 数量,sum(b.FAMOUNT) as 金额,count(a.FSOURCEBILLNO) as 分录行数 from tSfHxnShpSal_IoHis a
--left join tSfHxnShpSalPlu_IoHis b on a.FSOURCEBILLNO=b.FSOURCEBILLNO
--group by a.FSOURCEBILLNO,a.FDATE

if object_id('tempdb..#temp') is not null Begin
    drop table #temp
END

CREATE TABLE #temp (
原始单号 VARCHAR(max),
日期 DATETIME ,
数量 DECIMAL(32,2) ,
金额 DECIMAL(32,2) ,
分录行数 INT 
)

--金蝶无流水

SELECT a.原始单号,a.日期,b.FBILLNO,ABS(ISNULL(a.数量,0)) 数量, b.QTY, ABS( ISNULL(a.金额,0)) 金额, b.AMOUNT,
 ABS(ISNULL(a.数量,0))-b.QTY,ABS( ISNULL(a.金额,0))-b.AMOUNT

FROM #temp a
LEFT JOIN (
SELECT a.FBILLNO,a.FORIGINNUMBER,SUM(b.FREALQTY) QTY,SUM(c.FALLAMOUNT) AMOUNT FROM dbo.T_SAL_OUTSTOCK a
LEFT JOIN dbo.T_SAL_OUTSTOCKENTRY b ON a.FID=b.FID
LEFT JOIN dbo.T_SAL_OUTSTOCKENTRY_F c ON c.FENTRYID = b.FENTRYID
LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
WHERE a.FORIGINNUMBER IS NOT NULL AND  u.FNAME='Administrator'
GROUP BY a.FBILLNO,a.FORIGINNUMBER
UNION ALL
SELECT a.FBILLNO,a.FORIGINNUMBER,(SUM(b.FREALQTY)) QTY, (SUM(c.FALLAMOUNT)) AMOUNT FROM dbo.T_SAL_RETURNSTOCK a
LEFT JOIN dbo.T_SAL_RETURNSTOCKENTRY  b ON b.FID = a.FID
LEFT JOIN dbo.T_SAL_RETURNSTOCKENTRY_F c ON c.FENTRYID = b.FENTRYID
LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
WHERE a.FORIGINNUMBER IS NOT NULL AND  u.FNAME='Administrator'
GROUP BY a.FBILLNO,a.FORIGINNUMBER
) b ON a.原始单号=b.FORIGINNUMBER
WHERE a.日期>'2018-9-28' 
AND b.FBILLNO IS NULL  





--数据差异
SELECT b.FNAME,a.原始单号,a.日期,b.FBILLNO,ABS(ISNULL(a.数量,0)) 数量, b.QTY, ABS( ISNULL(a.金额,0)) 金额, b.AMOUNT,
 ABS(ISNULL(a.数量,0))-b.QTY,ABS( ISNULL(a.金额,0))-b.AMOUNT

FROM #temp a
LEFT JOIN (
SELECT a.FBILLNO,orgL.FNAME, a.FORIGINNUMBER,SUM(b.FREALQTY) QTY,SUM(c.FALLAMOUNT) AMOUNT FROM dbo.T_SAL_OUTSTOCK a
LEFT JOIN dbo.T_SAL_OUTSTOCKENTRY b ON a.FID=b.FID
LEFT JOIN dbo.T_SAL_OUTSTOCKENTRY_F c ON c.FENTRYID = b.FENTRYID
LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
LEFT JOIN dbo.T_ORG_ORGANIZATIONS org ON org.FORGID=a.FSTOCKORGID 
LEFT JOIN T_ORG_ORGANIZATIONS_L orgL ON orgL.FORGID=a.FSTOCKORGID
WHERE a.FORIGINNUMBER IS NOT NULL AND  u.FNAME='Administrator'
GROUP BY a.FBILLNO,a.FORIGINNUMBER,orgL.FNAME
UNION ALL
SELECT a.FBILLNO,orgL.FNAME,a.FORIGINNUMBER,(SUM(b.FREALQTY)) QTY, (SUM(c.FALLAMOUNT)) AMOUNT FROM dbo.T_SAL_RETURNSTOCK a
LEFT JOIN dbo.T_SAL_RETURNSTOCKENTRY  b ON b.FID = a.FID
LEFT JOIN dbo.T_SAL_RETURNSTOCKENTRY_F c ON c.FENTRYID = b.FENTRYID
LEFT JOIN dbo.T_SEC_USER u ON a.FAPPROVERID=u.FUSERID
LEFT JOIN dbo.T_ORG_ORGANIZATIONS org ON org.FORGID=a.FSTOCKORGID 
LEFT JOIN T_ORG_ORGANIZATIONS_L orgL ON orgL.FORGID=a.FSTOCKORGID
WHERE a.FORIGINNUMBER IS NOT NULL AND  u.FNAME='Administrator'
GROUP BY a.FBILLNO,a.FORIGINNUMBER,orgL.FNAME
) b ON a.原始单号=b.FORIGINNUMBER
WHERE a.日期>'2018-9-28' 
AND b.FBILLNO IS NOT  NULL  AND ABS(ABS(ISNULL(a.数量,0))-b.QTY)>1  OR  ABS(ABS( ISNULL(a.金额,0))-b.AMOUNT)>1